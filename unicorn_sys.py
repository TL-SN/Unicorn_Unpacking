# 模拟一下驱动试试
from qiling import *
from qiling.const import QL_VERBOSE
ROOTFS = "D:/Python/Environment/Python_3.87/install_pack_by_myself/qiling/examples/rootfs/x8664_windows"
ql = Qiling(
[rf"{ROOTFS}/bin/chall.sys"], 
ROOTFS,
verbose=0,
)


def hook_addr1(qi:Qiling):
    t = '''
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
        111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
        111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
        111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
        111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
        111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111
    111111111111111111111111111111111111111111111111111111111

    '''
    print(t)
    

def hook_addr2(qi:Qiling):
    t = '''
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    222222222222222222222222222222222222222222222222222222222
    '''
    print(t)
    
def dump(ql:Qiling):
    start_addr = ql.loader.pe_image_address
    mem_size = ql.loader.pe_image_size
    print(f"start_addr is {hex(start_addr)}")
    print(f"the mem_size is {hex(mem_size)}")
    
    dump_memory = ql.mem.read(start_addr,mem_size)
    fp = open("chall_ql_dump.sys","wb")
    fp.write(dump_memory)
    fp.close()
    ql.emu_stop()

# ql.hook_address(hook_addr1,0x000000140163335)
# ql.hook_address(hook_addr2,0x000000140001250)
ql.hook_address(dump,0x00000001406c8a26)
ql.run(end=0x000000140001255)   